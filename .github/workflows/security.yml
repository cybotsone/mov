FROM golang:1.25.5-alpine AS gitlfs-builder
RUN apk add --no-cache git build-base
RUN git clone https://github.com/git-lfs/git-lfs.git /src
WORKDIR /src
RUN make

FROM jenkins/inbound-agent:latest-alpine3.23-jdk21
USER root

RUN apk add --no-cache \
    python3 py3-pip \
    curl jq bind-tools unzip git bash \
    py3-cryptography py3-bcrypt py3-paramiko \
    build-base libffi-dev openssl-dev python3-dev \
    groff less git-lfs

# ---------------------------------------------
# FIX ALL PYTHON CVEs HERE
# ---------------------------------------------

# 1) Upgrade pip + setuptools to avoid:
#    - CVE-2024-6345
#    - CVE-2025-47273
RUN pip3 install --upgrade pip setuptools wheel --break-system-packages
RUN pip3 install "setuptools>=78.1.1" --break-system-packages

# 2) Install SAFE urllib3
#    Fixes:
#    - CVE-2025-66418
#    - CVE-2025-66471
RUN pip3 install "urllib3>=2.6.0" --break-system-packages

# 3) Upgrade boto3/botocore so they DO NOT down-grade urllib3 back to a vulnerable version
RUN pip3 install "boto3>=1.35.84" "botocore>=1.35.84" --break-system-packages

# 4) Install SAFE Ansible (fixes 9 CVEs):
#    Fixes:
#    - CVE-2021-3583
#    - CVE-2022-3697
#    - CVE-2020-25635
#    - CVE-2021-3620
#    - CVE-2020-14330
#    - CVE-2023-5115
#    - CVE-2025-14010
#    - CVE-2020-1736
RUN pip3 install "ansible>=9.0.0" --break-system-packages

# 5) Fix yaml CVE
#    - CVE-2023-2251
RUN pip3 install "PyYAML>=6.0.2" --break-system-packages

# 6) Fix py CVE (even if disputed)
#    - CVE-2022-42969
RUN pip3 install "py>=1.11.1" --break-system-packages

# 7) Fix black formatter CVE
#    - CVE-2024-21503
RUN pip3 install "black>=24.3.0" --break-system-packages

# 8) Fix deepdiff + other dependencies
RUN pip3 install --upgrade deepdiff passlib awscli --break-system-packages

# ---------------------------------------------
# END OF SECURITY FIXES
# ---------------------------------------------

COPY --from=gitlfs-builder /src/bin/git-lfs /usr/local/bin/git-lfs
